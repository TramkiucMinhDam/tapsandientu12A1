<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <link rel="stylesheet" href="style.css"/>
  <title>Flipbook</title>

  <audio id="bgMusic" loop>
    <source src="nhacnen.mp3" type="audio/mpeg">
  </audio>
</head>

<body>

<div class="flipbook">
    <div class="hard page"><img src="1.jpg"></div>

    <!-- VIDEO PAGE -->
   

    <!-- IMAGE PAGES -->
    <div class="hard page"><img src="2.jpg"></div>
    <div class="page"><img src="3.jpg"></div>
    <div class="page"><img src="4.jpg"></div>

    <div class="page video-page">
        <video class="video-ui" src="video1.mp4"></video>
        <input type="range" class="seekbar" value="0">
    </div>

    <div class="page"><img src="6.jpg"></div>
    <div class="page"><img src="7.jpg"></div>
    <div class="page"><img src="8.jpg"></div>
    <div class="page"><img src="9.jpg"></div>
    <div class="page"><img src="10.jpg"></div>
    <div class="page"><img src="11.jpg"></div>
    <div class="page"><img src="12.jpg"></div>
    <div class="page"><img src="13.jpg"></div>
    <div class="page"><img src="14.jpg"></div>
    <div class="page"><img src="15.jpg"></div>
    <div class="page"><img src="16.jpg"></div>
  
    <div class="page video-page">
        <video class="video-ui" src="https://archive.org/download/17_20251116/17.mp4"></video>
        <input type="range" class="seekbar" value="0">
    </div>
  
    <div class="page"><img src="18.jpg"></div>
    <div class="page"><img src="19.jpg"></div>
    <div class="page"><img src="20.jpg"></div>
    <div class="page"><img src="21.jpg"></div>
    <div class="page"><img src="22.jpg"></div>
    <div class="page"><img src="23.jpg"></div>
    <div class="page"><img src="24.jpg"></div>
    <div class="page"><img src="25.jpg"></div>
    <div class="page"><img src="26.jpg"></div>
    <div class="page"><img src="27.jpg"></div>
    <div class="page"><img src="28.jpg"></div>
    <div class="page"><img src="29.jpg"></div>
    <div class="page"><img src="30.jpg"></div>
    <div class="page"><img src="31.jpg"></div>
    <div class="page"><img src="32.jpg"></div>
    <div class="page"><img src="33.jpg"></div>
    <div class="page"><img src="34.jpg"></div>
    <div class="page"><img src="35.jpg"></div>
    <div class="page"><img src="36.jpg"></div>
    <div class="page"><img src="37.jpg"></div>
    <div class="page"><img src="38.jpg"></div>
    <div class="page"><img src="39.jpg"></div>
    <div class="page"><img src="40.jpg"></div>
    <div class="page"><img src="41.jpg"></div>
    <div class="page"><img src="42.jpg"></div>
    <div class="page"><img src="43.jpg"></div>
    <div class="page"><img src="44.jpg"></div>
    <div class="page"><img src="45.jpg"></div>
    <div class="page"><img src="46.jpg"></div>
    <div class="page"><img src="47.jpg"></div>
    <div class="page"><img src="48.jpg"></div>
    <div class="page"><img src="49.jpg"></div>
    <div class="page"><img src="50.jpg"></div>
    <div class="page"><img src="51.jpg"></div>
    <div class="page"><img src="52.jpg"></div>
    <div class="page"><img src="53.jpg"></div>
    <div class="page"><img src="54.jpg"></div>
    <div class="page"><img src="55.jpg"></div>
    <div class="page"><img src="56.jpg"></div>
    <div class="page"><img src="57.jpg"></div>
    <div class="page"><img src="58.jpg"></div>
    <div class="page"><img src="59.jpg"></div>
    <div class="page"><img src="60.jpg"></div>
  
    <div class="page video-page">
        <video class="video-ui" src="https://archive.org/download/tapsan/60.mp4"></video>
        <input type="range" class="seekbar" value="0">
    </div>
  
    <div class="page"><img src="62.jpg"></div>
    <div class="page"><img src="63.jpg"></div>
    <div class="page"><img src="64.jpg"></div>
    <div class="hard page"><img src="65.jpg"></div>
   <div class="hard page"><img src="66.jpg"></div>
</div>

<script src="jquery.js"></script>
<script src="turn.js"></script>

<script>
$(".flipbook").turn({
    display: "double",
    acceleration: true,
    gradients: true,
    elevation: 50,
});
</script>

<!-- ========== AUDIO MEMORY ========== -->
<script>
const audio = document.getElementById("bgMusic");

audio.addEventListener("loadedmetadata", () => {
    const t = localStorage.getItem("bgMusicTime");
    if (t) audio.currentTime = parseFloat(t);
});

audio.play().catch(()=>{});

window.addEventListener("beforeunload", () => {
    localStorage.setItem("bgMusicTime", audio.currentTime);
});
</script>

<!-- ========== VIDEO CONTROL (FIX SEEKBAR + PAUSE MUSIC) ========== -->
<script>
function setupAllVideos() {
    const pages = document.querySelectorAll(".page.video-page");
    const bgMusic = document.getElementById("bgMusic");
    const precision = 100;

    pages.forEach(page => {
        const video = page.querySelector("video");
        const seek  = page.querySelector(".seekbar");

        if (!video || !seek) return;

        // Nếu đã khởi tạo cho chính element video này thì bỏ qua
        if (video._inited) return;

        let metadataLoaded = false;

        // Hàm xử lý khi metadata sẵn sàng
        function onMeta() {
            metadataLoaded = true;
            // Nếu duration NaN hoặc 0 thì không set
            if (isFinite(video.duration) && video.duration > 0) {
                seek.max = Math.floor(video.duration * precision);
            } else {
                seek.max = 0;
            }
            seek.value = Math.floor(video.currentTime * precision);
        }

        // Thêm listener loadedmetadata
        video.addEventListener("loadedmetadata", onMeta);

        // Nếu metadata đã load trước khi gắn listener (readyState >= 1), gọi luôn
        if (video.readyState >= 1 && !metadataLoaded) {
            onMeta();
        }

        // Click để toggle play/pause
        video.addEventListener("click", () => {
            if (video.paused) video.play();
            else video.pause();
        });

        // Khi user kéo seekbar
        seek.addEventListener("input", () => {
            if (!metadataLoaded || seek.max === 0) return;
            // không auto play ở đây nếu bạn không muốn; ta set time nhưng không bắt phải play
            video.currentTime = seek.value / precision;
        });

        // Cập nhật seekbar liên tục (chỉ đọc giá trị nếu metadataLoaded)
        function updateSeek() {
            if (metadataLoaded && seek.max > 0) {
                // tránh set khi người dùng đang kéo (bổ sung: có thể detect bằng attribute 'data-user-seek' nếu cần)
                seek.value = Math.floor(video.currentTime * precision);
            }
            requestAnimationFrame(updateSeek);
        }
        updateSeek();

        // Pause background music khi video phát
        video.addEventListener("play", () => {
            try { bgMusic.pause(); } catch(e) {}
        });

        // Resume background music khi video pause hoặc kết thúc
        video.addEventListener("pause", () => {
            try { bgMusic.play().catch(()=>{}); } catch(e) {}
        });
        video.addEventListener("ended", () => {
            try { bgMusic.play().catch(()=>{}); } catch(e) {}
        });

        // Mark as inited để không thêm listener lần nữa cho chính element này
        video._inited = true;
    });
}

/* Khi lật trang: 
   - Pause tất cả video để tránh video chạy ẩn
   - Gọi setup để gắn listener cho các video mới (cloned) */
$(".flipbook").bind("turning", function(event, page) {
    // Pause mọi video hiện có
    document.querySelectorAll(".page.video-page video").forEach(v => {
        try { v.pause(); } catch(e) {}
    });
});

$(".flipbook").bind("turned", function(event, page) {
    // Chờ DOM của turn.js ổn định rồi setup
    setTimeout(setupAllVideos, 80);
});

// Run lần đầu
setupAllVideos();
</script>




</body>
</html>
